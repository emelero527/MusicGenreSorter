(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function a(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(n){if(n.ep)return;n.ep=!0;const o=a(n);fetch(n.href,o)}})();const P="a9efb5fedc654d20b0ad8aefa93858bd",R="https://emelero527.github.io/MusicGenreSorter/",O="user-library-read playlist-modify-public playlist-modify-private";let y=null,g=[],h={},E=null,f=0,$=[];const b=["Rap","Rock","Pop","Jazz","Electronic","Indie","Classical"],w={Rap:"#e74c3c",Rock:"#3498db",Pop:"#f39c12",Jazz:"#9b59b6",Electronic:"#1abc9c",Indie:"#2ecc71",Classical:"#95a5a6",Unassigned:"#444"};function I(){return"#"+Math.floor(Math.random()*16777215).toString(16)}function i(t){const e=document.getElementById("status");e&&(e.textContent=t),console.log("[APP]",t)}function c(t){return document.getElementById(t)}function B(){const t=window.location.hash.substring(1);return new URLSearchParams(t).get("access_token")}function T(){const t=new URL("https://accounts.spotify.com/authorize");t.searchParams.append("client_id",P),t.searchParams.append("response_type","token"),t.searchParams.append("redirect_uri",R),t.searchParams.append("scope",O),t.searchParams.append("show_dialog","true"),console.log("Redirecting to:",t.toString()),window.location.href=t.toString()}async function A(){if(!y)throw new Error("No access token available for fetchSavedSongs()");c("loading")?.style&&(c("loading").style.display="block");const t=c("loading-text");let e="https://api.spotify.com/v1/me/tracks?limit=50",a=0;try{for(;e;){const n=await fetch(e,{headers:{Authorization:"Bearer "+y}});if(!n.ok){const s=await n.text().catch(()=>n.statusText);console.error("Spotify tracks fetch failed:",n.status,s),i("Failed fetching tracks: "+n.status);break}const o=await n.json();o.items.forEach(s=>{const u=s.track;if(!u)return;const m={id:u.id,name:u.name,artist:u.artists.map(l=>l.name).join(", "),album:u.album?.name||"",cover:u.album?.images?.[0]?.url||"",genres:["Unassigned"]},p=localStorage.getItem(`song-${m.id}`);p&&(m.genres=[p]),g.push(m)}),a+=o.items.length,t&&(t.textContent=`Loading your songs... ${a} fetched`),e=o.next}S(),N();const r=parseInt(localStorage.getItem("currentIndex"),10);!isNaN(r)&&r<g.length&&(f=r,i(`Resuming from song ${f+1} of ${g.length}`)),k(f),i(`Fetched ${g.length} songs`)}catch(r){console.error("Error while fetching songs:",r),i("Error fetching songs (see console).")}finally{c("loading")?.style&&(c("loading").style.display="none")}}function S(){h={},g.forEach(t=>{const e=t.genres?.[0]||"Unassigned";h[e]||(h[e]=[]),h[e].push(t)})}function k(t){const e=c("song-card");if(!e)return;if(t>=g.length){e.classList.add("hidden"),alert("âœ… All songs sorted!"),i("All songs processed");return}const a=g[t];c("song-cover").src=a.cover||"",c("song-title").textContent=a.name||"",c("song-artist").textContent=a.artist||"",c("song-album").textContent=a.album||"";const r=c("genre-buttons");if(r){r.innerHTML="",b.forEach(o=>{const s=document.createElement("button");s.className="genre-assign-btn",s.type="button",s.textContent=o,s.style.backgroundColor=w[o]||"#444",s.addEventListener("click",()=>v(a,o)),r.appendChild(s)});const n=document.createElement("button");n.className="add-genre-btn",n.type="button",n.textContent="+ Add Genre",n.style.backgroundColor="#444",n.addEventListener("click",()=>{const o=prompt("Enter a new genre name:");o&&!b.includes(o)&&(b.push(o),w[o]=I(),alert(`âœ… Genre "${o}" added!`),k(t))}),r.appendChild(n)}e.classList.remove("hidden"),i(`Showing ${t+1} / ${g.length}`)}function v(t,e){$.push({id:t.id,prev:t.genres[0]||"Unassigned"}),t.genres=[e],localStorage.setItem(`song-${t.id}`,e),S(),N(),L(`ðŸŽµ "${t.name}" â†’ ${e}`),f++,localStorage.setItem("currentIndex",f),k(f)}function U(){if($.length===0){i("Nothing to undo");return}const t=$.pop(),e=g.find(a=>a.id===t.id);if(!e){console.warn("undo: song not found",t);return}e.genres=[t.prev||"Unassigned"],e.genres[0]==="Unassigned"?localStorage.removeItem(`song-${e.id}`):localStorage.setItem(`song-${e.id}`,e.genres[0]),f=Math.max(0,f-1),localStorage.setItem("currentIndex",f),S(),N(),k(f),i(`Undid last assignment: ${e.name}`)}function N(){const t=c("genreChart");if(!t){console.warn("genreChart canvas missing");return}const e=t.getContext("2d");S();const a=Object.keys(h),r=a.map(n=>h[n].length);E&&typeof E.destroy=="function"&&E.destroy(),E=new Chart(e,{type:"bar",data:{labels:a,datasets:[{label:"Songs per Genre",data:r,backgroundColor:"#1DB954"}]},options:{responsive:!0,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,ticks:{precision:0}}}}}),x()}function L(t){const e=c("toast");e&&(e.textContent=t,e.classList.add("show"),setTimeout(()=>{e.classList.remove("show")},2500))}function x(){const t=c("playlist-buttons");t&&(t.innerHTML="",Object.keys(h).forEach(e=>{if(e==="Unassigned")return;const a=document.createElement("div");a.className="genre-section";const r=document.createElement("button");r.textContent=`Create ${e} Playlist`,r.className="playlist-btn",r.addEventListener("click",()=>G(e)),a.appendChild(r);const n=document.createElement("button");n.textContent=`Show ${e} Songs`,n.className="show-songs-btn",a.appendChild(n);const o=document.createElement("ul");o.className="genre-song-list",o.style.display="none",h[e].forEach(s=>{const u=document.createElement("li");u.className="genre-list-item";const m=document.createElement("span");m.textContent=`${s.name} â€” ${s.artist}`,u.appendChild(m);const p=document.createElement("div");p.className="inline-buttons",b.forEach(d=>{if(d!==s.genres[0]){const C=document.createElement("button");C.className="inline-btn",C.textContent=d,C.style.backgroundColor=w[d]||"#444",C.addEventListener("click",()=>{v(s,d),x(),L(`ðŸŽµ "${s.name}" â†’ ${d}`)}),p.appendChild(C)}});const l=document.createElement("button");l.className="inline-btn",l.textContent="+ Add",l.style.backgroundColor="#444",l.addEventListener("click",()=>{const d=prompt("Enter a new genre name:");d&&!b.includes(d)&&(b.push(d),w[d]=I()),v(s,d),x(),L(`ðŸŽµ "${s.name}" â†’ ${d}`)}),p.appendChild(l),u.appendChild(p),o.appendChild(u)}),n.addEventListener("click",()=>{const s=o.style.display==="none";o.style.display=s?"block":"none",n.textContent=s?`Hide ${e} Songs`:`Show ${e} Songs`}),a.appendChild(o),t.appendChild(a)}))}async function G(t){if(!y){i("âŒ No access token, please log in first.");return}const e=h[t]||[];if(!e.length){i(`âš ï¸ No songs found for ${t}`);return}if(!confirm(`Are you sure you want to create a playlist for ${t}?`)){i(`Cancelled playlist creation for ${t}`);return}i(`Creating playlist for ${t}...`);const o=(await(await fetch("https://api.spotify.com/v1/me",{headers:{Authorization:"Bearer "+y}})).json()).id,s=await fetch(`https://api.spotify.com/v1/users/${o}/playlists`,{method:"POST",headers:{Authorization:"Bearer "+y,"Content-Type":"application/json"},body:JSON.stringify({name:`${t} Playlist`,description:`Songs auto-organized into ${t}`,public:!1})});if(!s.ok){i(`âŒ Failed to create playlist for ${t}`);return}const m=(await s.json()).id,p=e.map(l=>`spotify:track:${l.id}`);for(let l=0;l<p.length;l+=100){const d=p.slice(l,l+100);await fetch(`https://api.spotify.com/v1/playlists/${m}/tracks`,{method:"POST",headers:{Authorization:"Bearer "+y,"Content-Type":"application/json"},body:JSON.stringify({uris:d})})}i(`âœ… Playlist created for ${t}! Check your Spotify.`)}window.addEventListener("DOMContentLoaded",async()=>{console.log("DOM ready - attaching listeners");const t=c("login-btn");t&&t.addEventListener("click",T);const e=c("undo-btn");if(e&&e.addEventListener("click",U),i("Ready"),y=B(),y){try{window.history.pushState("",document.title,window.location.pathname)}catch{}i("Logged in â€” fetching songs...");const a=c("login-btn");a&&(a.style.display="none"),await A().catch(r=>{console.error("fetchSavedSongs error:",r),i("Error fetching songs â€” see console")})}else i("Not logged in. Click 'Login with Spotify' to start.")});
